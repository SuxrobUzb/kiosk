<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="app">
        <header>
            <div class="lang-switcher">
                <button @click="changeLang('uz_lat')">Uz (Lat)</button>
                <button @click="changeLang('uz_cyr')">–é–∑ (–ö–∏—Ä–∏–ª–ª)</button>
                <button @click="changeLang('ru')">–†—É</button>
                <button @click="changeLang('en')">En</button>
                <button @click="toggleTheme">üåô</button>
                <a href="/admin_logout">–í—ã—Ö–æ–¥</a>
            </div>
        </header>
        <main>
            <h1>–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>
            <nav>
                <ul>
                    <li><a href="/admin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a></li>
                    <li><a href="/admin/statistics">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
                </ul>
            </nav>
            <div class="section">
                <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
                <form id="stats-filter">
                    <label>–¢–∏–ø –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è:
                        <select v-model="viewType">
                            <option value="service">–ü–æ —É—Å–ª—É–≥–∞–º</option>
                            <option value="operator_overall">–ü–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º (–æ–±—â–µ–µ)</option>
                            <option value="operator_individual">–ü–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ)</option>
                        </select>
                    </label>
                    <label>–£—Å–ª—É–≥–∞:
                        <select v-model="serviceId">
                            <option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>
                            <option v-for="service in services" :value="service[0]">{{ service[1] }}</option>
                        </select>
                    </label>
                    <label>–û–ø–µ—Ä–∞—Ç–æ—Ä:
                        <select v-model="operatorId" :disabled="viewType !== 'operator_individual'">
                            <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</option>
                            <option v-for="operator in operators" :value="operator[0]">{{ operator[1] }}</option>
                        </select>
                    </label>
                    <label>–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä:
                        <select v-model="timeFilter">
                            <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                            <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                            <option value="half_yearly">–ü–æ–ª—É–≥–æ–¥–∏—á–Ω–æ</option>
                            <option value="yearly">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
                            <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π</option>
                        </select>
                    </label>
                    <label v-if="timeFilter === 'custom'">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:
                        <input type="date" v-model="startDate">
                    </label>
                    <label v-if="timeFilter === 'custom'">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:
                        <input type="date" v-model="endDate">
                    </label>
                    <button type="button" @click="fetchData">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button type="button" @click="exportData">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                </form>
            </div>
            <div class="section">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
                <div v-if="chartData.length">
                    <canvas id="statsChart"></canvas>
                </div>
                <table v-if="tableData.length">
                    <tr>
                        <th>–ù–æ–º–µ—Ä —Ç–∞–ª–æ–Ω–∞</th>
                        <th>–£—Å–ª—É–≥–∞</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                        <th>–ù–æ–º–µ—Ä –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–°–æ–∑–¥–∞–Ω–æ</th>
                        <th>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</th>
                        <th>–í—Ä–µ–º—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (–º–∏–Ω)</th>
                    </tr>
                    <tr v-for="row in tableData">
                        <td>{{ row['Ticket Number'] }}</td>
                        <td>{{ row['Service Name'] }}</td>
                        <td>{{ row['Category Name'] }}</td>
                        <td>{{ row['Operator Name'] }}</td>
                        <td>{{ row['Operator Number'] }}</td>
                        <td>{{ row['Status'] }}</td>
                        <td>{{ row['Created At'] }}</td>
                        <td>{{ row['Finished At'] }}</td>
                        <td>{{ row['Service Time'] ? row['Service Time'].toFixed(2) : 'N/A' }}</td>
                    </tr>
                </table>
            </div>
            <div class="section">
                <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
                <h3>–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
                <ul>
                    <li v-for="service in problemServices">
                        {{ service.name }}: –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è {{ service.avg_service_time.toFixed(2) }} –º–∏–Ω, –°–ø–æ—Ä—ã: {{ service.dispute_count }}
                    </li>
                </ul>
                <h3>–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</h3>
                <ul>
                    <li v-for="operator in problemOperators">
                        {{ operator.name }}: –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ {{ operator.avg_rating ? operator.avg_rating.toFixed(2) : 'N/A' }}, –°–ø–æ—Ä—ã: {{ operator.dispute_count }}
                    </li>
                </ul>
                <h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <ul>
                    <li v-for="rec in recommendations">
                        {{ rec.message }}
                    </li>
                </ul>
            </div>
        </main>
    </div>
    <script>
    new Vue({
        el: '#app',
        data: {
            currentLang: 'uz_lat',
            services: {{ services | tojson }},
            operators: {{ operators | tojson }},
            viewType: 'service',
            serviceId: '',
            operatorId: '',
            timeFilter: 'daily',
            startDate: '',
            endDate: '',
            tableData: [],
            chartData: [],
            problemServices: [],
            problemOperators: [],
            recommendations: [],
            chart: null
        },
        methods: {
            changeLang(lang) {
                this.currentLang = lang;
                // –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞
            },
            toggleTheme() {
                document.body.classList.toggle('dark-theme');
            },
            fetchData() {
                if (this.viewType === 'operator_individual' && (!this.operatorId || !this.serviceId)) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ —É—Å–ª—É–≥—É –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                    return;
                }
                const params = new URLSearchParams({
                    view_type: this.viewType,
                    time_filter: this.timeFilter,
                    ...(this.serviceId && { service_id: this.serviceId }),
                    ...(this.operatorId && { operator_id: this.operatorId }),
                    ...(this.timeFilter === 'custom' && { start_date: this.startDate, end_date: this.endDate })
                });
                axios.get(`/api/admin/statistics/data?${params}`)
                    .then(response => {
                        this.tableData = response.data.table_data;
                        this.chartData = response.data.chart_data;
                        this.updateChart();
                    });
                axios.get('/api/admin/recommendations')
                    .then(response => {
                        this.problemServices = response.data.problem_services;
                        this.problemOperators = response.data.problem_operators;
                        this.recommendations = response.data.recommendations;
                    });
            },
            updateChart() {
                const ctx = document.getElementById('statsChart').getContext('2d');
                if (this.chart) this.chart.destroy();
                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: this.chartData.map(item => item.time_period),
                        datasets: [
                            {
                                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–ª–æ–Ω–æ–≤',
                                data: this.chartData.map(item => item.ticket_count),
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (–º–∏–Ω)',
                                data: this.chartData.map(item => item.avg_service_time ? item.avg_service_time.toFixed(2) : 0),
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            },
            exportData() {
                const params = new URLSearchParams({
                    view_type: this.viewType,
                    time_filter: this.timeFilter,
                    ...(this.serviceId && { service_id: this.serviceId }),
                    ...(this.operatorId && { operator_id: this.operatorId }),
                    ...(this.timeFilter === 'custom' && { start_date: this.startDate, end_date: this.endDate })
                });
                window.location.href = `/api/admin/statistics/export?${params}`;
            }
        },
        mounted() {
            this.fetchData();
        }
    });
    </script>
</body>
</html>